---
title: Checking a package
layout: default
output: bookdown::html_chapter
---

# 자동 검사(Automated checking) {#check}

팩키지 개발 과정에 있어 중요한 부분이 `R CMD check`이다.
`R CMD check`가 자동으로 흔한 문제에 대해 코드를 점검한다.
CRAN에 제출 계획이 있다면 매우 중요하다.
하지만, 그렇지 않다고 하더라도 유용한데 이유는 그렇지 않다면 어려운 방식으로 찾아낼 수 있는 많은 일반적인 문제를 자동으로 탐지해준다.

`R CMD check`를 처음 실행하면 정신적 공황을 준다 - 고칠 필요가 있는 너무나 많은 문제가 발견되기 때문이다.
`R CMD check`가 덜 좌절을 주게 만드는 핵심방법은 좀더 자주 명령어를 실행하는 것이다: 문제를 좀더 일찍 발견하면 할수록, 버그를 고치기 더 쉽다. 이러한 접근법의 상한은 변경사항을 만들때마다 `R CMD check`를 실행하는 것이다. 만약 GitHub을 사용한다면, [Travis-CI](#travis)에서 정확하게 수행하는 방법을 학습할 것이다.

## 작업흐름 {#check-workflow}

`R CMD check`는 터미널에서 실행하는 명령어 명칭이다.
저자는 이 명령어를 직접 호출하는 것을 추천하지는 않는다.
대신에, `devtools::check()`을 실행하거나 RStudio에서 Cmd + Shift + E 단축키를 누른다. `R CMD check`와 대비해서, `devtools::check()`는 다음을 수행한다:


* 문서도 `devtools::document()` 명령을 실행해서 최신으로 갱신되게 확실히 한다.

* 점검전에 팩키지를 번들로 묶는다. 이러한 접근법이 팩키지 점검에 모범사례가 되는데 
  이유는 깨끗한 상태에서 점검 시작을 보장한다: 팩키지 번들은 소스 팩키지에 축적되는
  예를 들어, 컴파일 코드와 동반되는 `.so`, `.o` 같은 어떤 임시 파일도 포함하지 않아서, 
  임시 파일이 만들어 내는 거짓 경고를 피할 수 있다.

* `NOT_CRAN` 환경변수를 `TRUE`로 설정한다. 이 설정을 통해서 CRAN 테스트를 선택적으로
  건너뛸 수 있다 (자세한 사항은 `?testthat::skip_on_cran` 참조)

팩키지를 점검하는 작업흐름은 단순하지만, 귀찮다:


1. `devtools::check()` 명령어를 실행하거나, Ctrl/Cmd + Shift + E 단축키를 누른다.

1. 첫번째 문제를 고친다.

1. 더이상 어떤 문제가 없을 때까지 반복한다.

`R CMD check` 실행하면 세가지 메시지 유형이 반환된다:

  * 오류(`ERROR`): CRAN에 제출하든 제출하지 않든지 관계없이 고쳐야되는 심각한 문제.
    
  * 경고(`WARNING`): CRAN에 제출할 계획이 있다면 (계획이 없더라도 들여다보는 것은 좋은 생각이 되는) 
    고쳐야만 되는 가능성 있는 문제.
  
    
  * 유의(`NOTE`): 가벼운 문제. CRAN에 제출하려면, 설사 거짓양성이라고 하더라도 
    모든 유의(NOTE)사항을 제거해야만 된다.
    만약 유의(NOTE)사항이 하나도 없다면, 사람개입은 필요하지 않고,
    팩키지 제출 과정이 더 쉬워진다.
    만약 유의(NOTE)사항을 제거하는 것이 가능하지 않다면,
    [release notes](#release-check)에 기술된 것 처럼 제출 주석에 왜 OK인지 사유를 기술할 필요가 있다.
    만약 CRAN에 제출하지 않는다면, 주의깊이 각 유의(NOTE)사항을 읽을 필요는 있지만,
    본인이 생각하기에 문제가 되지 않는 것을 굳이 고칠 필요는 없다.
  

## 검사(Checks) {#check-checks}

`R CMD check`는 50개가 넘는 개별 검사로 구성되어 있고, 다음 절에서 차례로 기술된다.
각 검사에 대해서 무슨 검사를 수행하고, 가장 흔한 문제가 무엇이며, 고치는 방법을 간략하게 기술한다.
`R CMD check` 검사에 문제가 있고, 고치는 방법을 이해하지 못한다면, 적절한 조치를 취하는데 도움을 받을 수 있도록 다음 목록을 사용하라. 검사가 어떻게 하면 잘 맞는지 이해하기 쉽도록, 검사방법을 이 책 장(chapter)에 맞춰 대략 절(section)로 재구성했다. 이것이 의미하는 바는 `check()` 명령어를 실행할 때 보는 것과 다소 순서가 다를 수 있다는 것이다.

여기 목록에는 R 3.1.1 환경에서 실행한 모든 검사가 포함된다.
좀더 최신 버젼을 사용한다면, 이 장에 대한 가장 최신 온라인 버젼을 참조해도 좋다: <http://r-pkgs.had.co.nz/check.html>.
이 장으로도 해결되지 않는 문제에 봉착했다면, [저자에게 전자우편](mailto:hadley@rstudio.com)을 통해 연락을 주기 바란다.

### 메타데이터 검사

`R CMD check`은 항상 현재 환경정보를 기술하면서 시작된다.
저자는 UTF-8 문자집합을 갖고 맥 OS X에 R 3.1.1을 운영하고 있다:

* __Using log directory__ ‘/Users/hadley/Documents/web/httr.Rcheck’
* __Using R version__ 3.1.1 (2014-07-10)
* __Using platform__: x86_64-apple-darwin13.1.0 (64-bit)
* __Using session charset__: UTF-8

다음으로 기술된 정보가 파싱되고 팩키지 버젼이 출력된다.
여기서 httr 버젼 0.5.0.9000 을 검사한다 ([versioning](#version)에서 이상한 버젼 숫자에 관해 좀더 학습할 것이다).

<!-- https://github.com/wch/r-source/blob/trunk/src/library/tools/R/check.R#L3459 -->
* __Checking for file__ ‘httr/DESCRIPTION’
* __This is package__ ‘httr’ __version__ ‘0.5.0.9000’

### 팩키지 구조

<!-- https://github.com/wch/r-source/blob/trunk/src/library/tools/R/check.R#L257 -->
* __Checking package directory__. 검사하는 디렉토리가 존재해야만 된다.
  - `devtools::check()`은 이 문제에 대해 보호막을 제공한다.

<!-- https://github.com/wch/r-source/blob/trunk/src/library/tools/R/check.R#L3720 -->
* __Checking if this is a source package__. 바이너리나 설치된 팩키지가 아닌 소스 팩키지를 
  검사해야 된다. `devtools::check()`을 사용하면 결코 실패하지 않고 넘어간다.

<!-- https://github.com/wch/r-source/blob/trunk/src/library/tools/R/check.R#L3015 -->
* __Checking for executable files__. 팩키지에 절대 실행가능한 파일이 있으면 안된다:
  이식성도 없고, 오픈 소프트웨어도 아니고, 보안위험도 있다. 팩키지에 모든 실행가능한 파일을 삭제하라.
  (CRAN에 제출하지 않는다면, `DESCRIPTION` 파일에 `BinaryFiles` 필드에 실행가능 파일을 목록으로 올리면
  이 경고 메시지를 침묵시킬 수 있다.)


<!-- https://github.com/wch/r-source/blob/trunk/src/library/tools/R/check.R#L3103 -->
* __Checking for hidden files and directories__. 리눅스와 맥 OS X에서 `.`으로 시작되는 파일은
  디폴트 기본설정으로 숨겨진다. 아마도 실수로 팩키지에 숨긴 파일이 포함될 수도 있다.
  삭제하거나 만약 중요하다고 판단되면, `.Rbuildignore`를 사용해서 팩키지 번들에서 제거한다.
  자동으로 R은 `.git`, `.svn` 같은 흔한 디렉토리는 제거한다.

<!-- https://github.com/wch/r-source/blob/trunk/src/library/tools/R/check.R#L381 -->
* __Checking for portable file names__. R 팩키지는 윈도우, 리눅스, 맥 OS X에서 동작되어야 된다.
  그래서, 모든 플랫폼에서 동작되는 파일명칭만 사용될 수 있다.
  가장 쉬운 방법은 문자, 숫자, 밑줄, 대쉬만 사용하면 된다.
  비영어권 문자와 공백은 피한다.
  목록에 등재된 파일을 다시 이름지어서 검사를 통과한다.
  
<!-- https://github.com/wch/r-source/blob/trunk/src/library/tools/R/check.R#L541 -->
* __Checking for sufficient/correct file permissions__. 파일을 읽어들일 수 없다면,
  검사를 할 수 없다. 이 검사를 통해서 읽어들일 권한이 없는 파일이 팩키지에 포함되는 
  일어날 것 같지 않는 사례를 탐지한다. 파일에 권한부여를 통해서 해당 문제를 해결한다.

<!-- https://github.com/wch/r-source/blob/trunk/src/library/tools/R/check.R#L3141 -->
* __Checking whether package ‘XYZ’ can be installed__. `R CMD check`는 
  `R CMD install` 명령을 실행해서 작성한 팩키지 설치가 가능한지 확실히 한다.
  만약 이것이 실패하면, `devtools::install()` 혹은 RStudio Build & Reload 명령을 실행해서,
  더 진행하기 전에 모든 문제를 디버그한다.


<!-- https://github.com/wch/r-source/blob/trunk/src/library/tools/R/check.R#L3459 -->
* __Checking installed package size__. 우연히 매우 큰 파일이 포함되어 팩키지 크기를 실제보다
  부풀리기 쉽다. 이 검사를 통해서 전체 팩키지가 5MB보다 적고 각 디렉토리가 1MB 이하로 확실히 만든다.
  이 메시지를 보게되면, 우연히 대용량 파일을 포함하지 않았는지 점검한다.
  
  CRAN에 제출한다면, 팩키지 크기를 정당화할 필요가 있다.
  먼저 팩키지가 가능하면 작게 만들었는지 확실히 한다:
  데이터를 다시 압축한다, [data CRAN notes](#data-cran); 
  소품문(vignette)을 최소화한다, [vignette CRAN notes](#vignette-cran).
  만약 그래도 여전히 크다면, 데이터를 원래 팩키지로 이동하는 것도 고려해보라.

<!-- https://github.com/wch/r-source/blob/trunk/src/library/tools/R/check.R#L746 -->
* __Checking top-level files__. 지정한 파일과 디렉토리만 팩키지 최상단에 올릴 수 있다
  (예를 들어, `DESCRIPTION`, `R/`, `src/`).
  다른 파일을 포함시키려면, 두가지 선택지가 있다:


    * 설치될 필요가 없다면 (즉, 소스 팩키지에만 사용된다면):
      `devtools::use_build_ignore()` 명령어로 `.Rbuildignore` 파일에 해당 파일과 디렉토리를 추가한다.
    
    * 꼭 설치된다면: 파일과 디렉토리를 `inst/` 디렉토리로 옮긴다.
      설치되고 나면, 최상위 팩키지 디렉토리로 다시 옮겨지게 된다.

<!-- https://github.com/wch/r-source/blob/trunk/src/library/tools/R/check.R#L924 -->
* __Checking package subdirectories__. 

    * 빈 어떤 디렉토리도 포함하지 마라.
      `R CMD build` 명령어로 자동적으로 보통 삭제되서 이런 오류는 보이지 말아야 된다.
      만약 이와 관련된 오류를 본다면, 해당 디렉토리만 삭제하라.
      
    * 파일과 디렉토리가 중요한 경우. 모든 하위디렉토리는 `R/`을 제외하고 
      모두 소문자로 표기되어야 된다. 만약 인용 파일이 존재한다면 
      `inst/CITATION`에 위치해된다. 필요하면 이름을 다시 짓는다.
      
    * `inst/` 디렉토리 내용은 팩키지 최상위 내용과 충돌하지 말아야 된다
      (`build/`, `R/`등과 같이). 만약 충돌이 발생하면, 파일/디렉토리 명칭을 다시 정한다.

<!-- https://github.com/wch/r-source/blob/trunk/src/library/tools/R/check.R#L859 -->
* __Checking for left-over files__. 여기 목록에 올라온 파일은 모두 삭제한다.
  우연히 작성한 팩키지에 포함된 파일이다.

### 기술(Description)

<!-- https://github.com/wch/r-source/blob/trunk/src/library/tools/R/check.R#L597 -->
* __Checking DESCRIPTION meta-information__. 

    * `DESCRIPTION`은 유효해야만 된다. 여기 오류를 볼 것 같지는 않다.
      왜냐하면 팩키지를 다시 적재할 때마다 동일한 검사를 `devtools::load_all()`이 실행하기 때문이다.
    
    * 만약 `DESCRIPTION` 파일에 어떤 비아스키(non-ASCII) 문자를 사용하게되면,
      인코딩도 명세해야만 된다. 모든 플랫폼에 동작하는 인코딩은 단지 3가지만 존재한다:
      latin1, latin2, UTF-8. 저자는 강력하게 UTF-8을 추천한다:
      `Encoding: UTF-8`.
    
    * `License`는 이미 알려진 라이선스(전체 라이선스 목록은
      <https://svn.r-project.org/R/trunk/share/licenses/license.db>
      에서 확인)를 지칭하거나 `file LICENSE`을 사용해야 하고, 해당 파일은
      함께 존재해야만 된다. 여기서 오류는 오탈자 때문일 가능성이 높다.
    
    * `Authors@R` 혹은 `Authors`와 `Maintainer` 정보를 제공해야 된다.
      만약 양쪽 모두 명세해서 지정한다면 오류가 생긴다.
      원치않는 한쪽을 제거하면 오류를 고칠 수 있다.

<!-- https://github.com/wch/r-source/blob/trunk/src/library/tools/R/check.R#L3683
tools:::.check_package_depends -->
* __Checking package dependencies__. 

    * `Depends`, `Imports`, `LinkingTo` 목록에 올라간 모든 팩키지는 설치되어야 되고
      버젼 요구사항은 충족되어야만 되는데, 그렇지 않으면 팩키지를 검사할 수 없다.
      빠지거나 오래된 의존성을 설치하는 쉬운 방법은 `devtools::install_deps(dependencies = TRUE)` 
      명령어를 실행하는 것이다.
  
    * `Suggests` 목록에 등재된 팩키지는 설치되어야만 한다.
      만약 그렇지 않다면, 환경변수 `_R_CHECK_FORCE_SUGGESTS_`을 `false` 값으로 설정한다
      (즉, `check(force_suggests = FALSE)`).
      제안 팩키지가 모든 플랫폼에 이용가능하지 않은 경우에 이것을 유용하게 사용할 수 있다.
      
    * R 팩키지는 의존성 사이클을 갖을 수 없다: 즉, 만약 팩키지 A가 B를 요구하면,
      팩키지 B는 A를 요구할 수 없다 (그렇지 않다면, 어느 팩키지를 먼저 적재할 것인가?).
      만약 여기 오류를 보게 되면, 팩키지 설계를 다시 생각할 필요가 있다.
      한가지 쉬운 수정방법은 충돌나는 팩키지를 `Imports` 혹은 `Depends`에서 
      `Suggests`로 옮기는 것이다.
      
    * `NAMESPACE`에 사용되는 어떤 팩키지나 `Imports` (가장 흔한 경우) 혹은 `Depends` (특별한 경우에만) 중 
      한곳에 등재되어야만 된다. 좀더 자세한 사항에 대해서는 [search path](#search-path)을 참조한다.

    * `Depends`에 등재된 모든 팩키지는 `NAMESPACE`에 가져오거나 `pkg::foo` 명령으로 접근할 수 있어야 된다.
      만약 이 작업을 수행하지 않으면, 검색경로에 (`library(mypackage)` 명령어로) 부착될 때만 
      작성한 팩키지가 동작하고, 적재만 되면 동작하지 않게 된다 (예를 들어, `mypackage::foo()`)

<!-- https://github.com/wch/r-source/blob/trunk/src/library/tools/R/check.R#L3561 
tools:::.check_package_CRAN_incoming
-->
* __Checking CRAN incoming feasibility__. 만약 CRAN에 제출하는 경우에만 해당 검사가 적용된다.
  
    * 신규 팩키지를 제출하려면, 기존 팩키지와 동일한 명칭을 사용할 수 없다.
      신규 명칭을 제안할 필요가 있다.
    
    * 만약 갱신된 팩키지를 제출하면, 버젼숫자는 현재 CRAN 버젼 숫자보다 높아야만 된다.
      `DESCRIPTION` 파일에 `Version` 필드를 갱신하라.
      
    * 팩키지 유지보수담당자가 변경되었다면 (전자우편주소에 변경만 있더라도),
      신입 유지보수담당자가 CRAN에 제출해야 되고, 이전 유지보수담당자는 확인 전자우편을 전송해야 한다.

    * <https://svn.r-project.org/R/trunk/share/licenses/license.db>에 등재된 표준 공개 소프트웨어 라이선스를
      사용해야만 한다. CRAN에는 사용자 정의 계약을 검토할 법적 자원이 없어서,
      사용자 정의 라이선스를 사용할 수 없다.
    
    * `Title`과 `Description`에는 철자 오류가 없어야만 된다.
      팩키지 제목은 각 제목 단어 첫자가 대문자로 표현되는 title case로 적는다.
      제목과 기술 어디에도 작성한 팩키지 명칭과 "package" 단어가 포함되면 안된다.
      필요하면 제목과 기술정보를 다시 작성한다.
   
    * 만약 신규 팩키지를 제출하려면, 항상 유의(`NOTE`) 사항을 받게된다.
      CRAN 유지보수담당자에게 몇가지 부가적인 수작업 검사를 상기시켜준다.
    
    * 단기간에 동일한 팩키지를 다수 버젼으로 제출하는 것은 피하라
      CRAN에서는 한달에 많아야 한번 제출된 것을 선호한다.
      만약 주요 버그를 고칠 필요가 있다면, 사과하라.

### 네임스페이스(Namespace)

<!-- https://github.com/wch/r-source/blob/trunk/src/library/tools/R/check.R#L4433 -->
* __Checking if there is a namespace__. `NAMESPACE` 파일이 있어야만 된다.
  Roxygen2가 [namespaces](#namespace)에 기술되듯이 개발자를 위해 해당 파일을 생성한다.

<!-- https://github.com/wch/r-source/blob/trunk/src/library/tools/R/check.R#L3620 -->
* __Checking package namespace information__. `NAMESPACE`는 `parseNamespaceFile()` 명령어로
  파싱할 수 있어야 되고 유효해야 된다.
  만약 해당 검사가 실패하면, roxygen2에 버그다.

<!-- https://github.com/wch/r-source/blob/trunk/src/library/tools/R/check.R#L2234 -->
* __Checking whether the package can be loaded with stated dependencies__.
  `R_DEFAULT_PACKAGES=NULL`로 `library(pkg)`를 실행하면, 검색경로에는 아무것도 없게 된다
  (즉, stats, graphics, grDevices, utils, datasets, methods가 보통때처럼 부착되지는 않는다).
  일반적으로 여기서 실패는 팩키지 중에 하나에서 의존성이 빠졌다는 것을 나타낸다.

<!-- https://github.com/wch/r-source/blob/trunk/src/library/tools/R/check.R#L2264 -->
* __Checking whether the namespace can be loaded with stated dependencies__.
  `R_DEFAULT_PACKAGES=NULL`로 `loadNamespace(pkg)`을 실행한다.
  일반적으로 여기서 실패는 네임스페이스에 문자가 있음을 나타낸다.

### R 코드

<!-- https://github.com/wch/r-source/blob/trunk/src/library/tools/R/check.R#L1226 -->
* __Checking R files for non-ASCII characters__. For maximum portability (i.e.
  so people can use your package on Windows) you should avoid using non-ASCII
  characters in R files. It's ok to use them in comments, but object names 
  shouldn't use them, and in strings you should use unicode escapes. See 
  [`R/` CRAN notes](#r-cran) for more details.

<!-- https://github.com/wch/r-source/blob/trunk/src/library/tools/R/check.R#L1258 -->
* __Checking R files for syntax errors__. Obviously your R code must be valid.
  You're unlikely to see this error if you're been regularly using 
  `devtools::load_all()`.

<!--- tools:::.check_packages_used --->
* __Checking dependencies in R code__. Errors here often indicate that you've 
  forgotten to declare a needed package in the `DESCRIPTION`. Remember that you 
  should never use `require()` or `library()` inside a package - see 
  [namespace imports](#imports) for more details on best practices.
  
    Alternatively, you may have accidentally used `:::` to access an exported
    function from a package. Switch to `::` instead.

<!--- tools::checkS3methods --->
* __Checking S3 generic/method consistency__. S3 methods must have a compatible 
  function signature with their generic. This means that the method must have the 
  same arguments as its generic, with one exception: if the generic includes 
  `...` the method can have additional arguments. 
  
    A common cause of this error is defining print methods, because the 
    `print()` generic contains`...`:
  
    ```{r}
    # BAD
    print.my_class <- function(x) cat("Hi")
    
    # GOOD
    print.my_class <- function(x, ...) cat("Hi")
    
    # Also ok
    print.my_class <- function(x, ..., my_arg = TRUE) cat("Hi")
    ```

<!-- tools::checkReplaceFuns -->
* __Checking replacement functions__. Replacement functions (e.g. functions that
  are called like `foo(x) <- y`), must have `value` as the last argument.

<!-- https://github.com/wch/r-source/blob/trunk/src/library/tools/R/check.R#L1373
     tools:::.check_package_code_shlib
     tools:::.check_package_code_startup_functions
     tools:::.check_package_code_unload_functions
     tools:::.check_package_code_tampers
     tools:::.check_code_usage_in_package
     tools:::.check_dotInternal
     tools:::.check_package_code_assign_to_globalenv
     tools:::.check_package_code_attach
     tools:::.check_package_code_data_into_globalenv
     tools:::.check_depdef
     -->
* __Checking R code for possible problems__. This is a compound check for 
    a wide range of problems:

    * Calls to `library.dynam()` (and `library.dynam.unload()`) should look
      like `library.dynam("name")`, not `library.dynam("name.dll")`. Remove
      the extension to fix this error.
      
    * Put `library.dynam()` in `.onLoad()`, not `.onAttach()`;
      put `packageStartupMessage()` in `.onAttach()`, not `.onLoad()`.
      Put `library.dynam.unload()` in `.onUnload()`. If you use any of 
      these functions, make sure they're in the right place.
  
    * Don't use `unlockBinding()` or `assignInNamespace()` to modify objects
      that don't belong to you. 
      
    * `codetools::checkUsagePackage()` is called to check that your functions
      don't use variables that don't exist. This sometimes raises false 
      positives with functions that use non-standard evaluation (NSE),
      like `subset()` or `with()`. Generally, I think you should avoid NSE in 
      package functions, and hence avoid this NOTE, but if you can not, see 
      `?globalVariables` for how to suppress this NOTE.
      
    * You are not allowed to use `.Internal()` in a package. Either call 
      the R wrapper function, or write your own C function. (If you copy and 
      paste the C function from base R, make sure to maintain the copyright 
      notice, use a GPL-2 compatible license, and list R-core in the `Author` 
      field.)
    
    * Similarly you are not allowed to use `:::` to access non-exported
      functions from other packages. Either ask the package maintainer to
      export the function you need, or write your own version of it using
      exported functions. Alternatively, if the licenses are compatible you
      can copy and paste the exported function into your own package. If
      you do this, remember to update `Authors@R`.

    * Don't use `assign()` to modify objects in the global environment. If 
      you need to maintain state across function calls, create your own
      environment with `e <- new.env(parent = emptyenv())` and set and 
      get values in it:
      
        ```{r}
        e <- new.env(parent = emptyenv())
        
        add_up <- function(x) {
          if (is.null(e$last_x)) {
            old <- 0
          } else {
            old <- e$last_x
          }
          
          new <- old + x
          e$last_x <- new
          new
        }
        add_up(10)
        add_up(20)
        ```      
  
    * Don't use `attach()` in your code. Instead refer to variables 
      explicitly.
  
    * Don't use `data()` without specifying the `envir` argument. Otherwise
      the data will be loaded in the global environment.
      
    * Don't use deprecated or defunct functions. Update your code to use 
      the latest versions.
  
    * You must use `TRUE` and `FALSE` in your code (and examples), not `T` and 
      `F`.
    
<!-- https://github.com/wch/r-source/blob/trunk/src/library/tools/R/check.R#L2209 -->
* __Checking whether the package can be loaded__. R loads your package with
  `library()`. Failure here typically indicates a problem with 
  `.onLoad()` or `.onAttach()`.

<!-- https://github.com/wch/r-source/blob/trunk/src/library/tools/R/check.R#L2247 -->
* __Checking whether the package can be unloaded cleanly__. Loads with 
  `library()` and then `detach()`es. If this fails, check `.onUnload()` and 
  `.onDetach()`.

<!-- https://github.com/wch/r-source/blob/trunk/src/library/tools/R/check.R#L2279 -->
* __Checking whether the namespace can be unloaded cleanly__.
  Runs `loadNamespace("pkg"); unloadNamespace("pkg")`. Check `.onUnload()` for 
  problems.

<!-- https://github.com/wch/r-source/blob/trunk/src/library/tools/R/check.R#L2300 -->
* __Checking loading without being on the library search path__.
  Calls `library(x, lib.loc = ...)`. Failure here indicates that you are 
  making a false assumption in `.onLoad()` or `.onAttach()`.

### Data

<!-- 
https://github.com/wch/r-source/blob/trunk/src/library/tools/R/check.R#L1782 
tools:::.check_package_datasets
tools:::.check_package_compact_datasets
tools:::.check_package_compact_sysdata
-->
* __Checking contents of 'data' directory__.

    * The data directory can only contain file types described in 
      [exported data](#data-data).
      
    * Data files can only contain non-ASCII characters if the encoding is 
      not correctly set. This usually shouldn't be a problem if you're saving
      `.Rdata` files. If you do see this error, look at the `Encoding()` of
      each column in the data frame, and ensure none are "unknown". (You'll 
      typically need to fix this somewhere in the import process).
      
    * If you've compressed a data file with `bzip2` or `xz` you need to declare
      at least `Depends: R (>= 2.10)` in your `DESCRIPTION`.
      
    * If you've used a sub-optiomal compression algorithm for your data, 
      re-compress with the suggested algorithm.

### Documentation

You can run the most common of these outside `devtools::check()` with `devtools::check_doc()` (which automatically calls `devtools::document()` for you). If you have documentation problems, it's best to iterate quickly with `check_doc()`, rather than running the full check each time. 

<!-- https://github.com/wch/r-source/blob/trunk/src/library/tools/R/check.R#L1527 -->
* __Checking Rd files__. This checks that all `man/*.Rd` files use the correct
  Rd syntax. If this fails, it indicates a bug in roxygen2.

<!-- tools:::.check_Rd_metadata -->
* __Checking Rd metadata__. Names and aliases must be unique across all 
  documentation files in a package. If you encounter this problem you've 
  accidentally used the same `@name` or `@aliases` in multiple places; make 
  sure they're unique.

<!-- tools:::.check_Rd_line_widths -->
* __Checking Rd line widths__.  Lines in Rd files must be less than 90 
  characters wide. This is unlikely to occur if you wrap your R code,
  and hence roxygen comments, to 80 characters. For very long urls, use a 
  link-shortening service like [bit.ly](http://bit.ly).

<!-- tools:::.check_Rd_xrefs -->
* __Checking Rd cross-references__. Errors here usually represent typos.
  Recall the syntax for linking to functions in other packages: 
  `\link[package_name]{function_name}`. Sometimes I accidentally switch the
  order of `\code{}` and `\link{}`: `\link{\code{function}}` will not work.

<!-- tools::undoc -->
* __Checking for missing documentation entries__. All exported objects must 
  be documented. See `?tools::undoc` for more details.

<!-- tools::codoc, tools::codocData, tools::codocClasses -->
* __Checking for code/documentation mismatches__. This check ensures that the
  documentation matches the code. This should never fail because you're using
  roxygen2 which automatically keeps them in sync.

<!-- tools::checkDocFiles, tools::checkDocStyle -->
* __Checking Rd `\usage` sections__.  All arguments must be documented, and 
  all `@params` must document an existing argument. You may have forgotten to
  document an argument, forgotten to remove the documentation for an argument
  that you've removed, or misspelled an argument name.
  
    S3 and S4 methods need to use special `\S3method{}` and `\S4method{}` 
    markup in the Rd file. Roxygen2 will generate this for you automatically.

<!-- tools:::.check_Rd_contents -->
* __Checking Rd contents__. This checks for autogenerated content made by
  `package.skeleton()`. Since you're not using `package.skeleton()` you should
  never have a problem here.

<!-- tools:::.check_packages_used_in_examples -->
* __Checking for unstated dependencies in examples__. If you use a package 
  only for an example, make sure it's listed in the `Suggests` field. Before
  running example code that depends on it, test to see if it's available with
  `requireNamespace("pkg", quietly = TRUE)`:
  
    ```{r}
    #' @examples
    #' if (requireNamespace("dplyr", quietly = TRUE)) {
    #'   ...
    #' }
    ```

<!-- https://github.com/wch/r-source/blob/trunk/src/library/tools/R/check.R#L2317 -->
* __Checking examples__. Every documentation example must run without errors,
  and must not take too long. Exclude failing or slow tests with `\donttest{}`.
  See [documenting functions](#man-functions) for more details.
  
    Examples are one of the last checks run, so fixing problems can be painful 
    if you have to run `devtools::check()` each time. Instead, use 
    `devtools::run_examples()`: it only checks the examples, and has an optional 
    parameter which tells it which function to start at. That way once you've 
    discovered an error, you can rerun from just that file, not all the 
    files that lead up to it.
    
    NB: you can't use unexported functions and you shouldn't open new 
    graphics devices or use more than two cores. Individual examples shouldn't
    take more than 5s.
    
<!-- https://github.com/wch/r-source/blob/trunk/src/library/tools/R/check.R#L2925 -->
* __Checking PDF version of manual__. Occassionally you'll get an error when 
  building the PDF manual. This is usually because the pdf is built by latex and 
  you've forgotten to escape something. Debugging this is painful - your best 
  bet is to look up the latex logs and combined tex file and work back from 
  there to `.Rd` files then back to a roxygen comment. I consider any such
  failure to be a bug in roxygen2, so please let me know.

### Demos

<!-- https://github.com/wch/r-source/blob/trunk/src/library/tools/R/check.R#L877 -->
* __Checking index information__. If you've written demos, each demo must be 
  listed in `demos/00Index`. The file should look like:
    
    ```
    demo-name-without-extension  Demo description
    another-demo-name            Another description
    ```

### Compiled code

<!-- tools::checkFF -->
* __Checking foreign function calls__. `.Call()`, `.C()`, `.Fortran()`, 
  `.External()` must always be called either with a `NativeSymbolInfo` object
  (as created with `@useDynLib`) or use the `.package` argument. See
  `?tools::checkFF` for more details.

<!-- https://github.com/wch/r-source/blob/trunk/src/library/tools/R/check.R#L2065 -->
* __Checking line endings in C/C++/Fortran sources/headers__. Always
  use LF as a line ending.

<!-- https://github.com/wch/r-source/blob/trunk/src/library/tools/R/check.R#L2084 -->
* __Checking line endings in Makefiles__. As above.

<!-- https://github.com/wch/r-source/blob/trunk/src/library/tools/R/check.R#L2120 -->
* __Checking for portable use of `$(BLAS_LIBS)` and `$(LAPACK_LIBS)`__. 
  Errors here indicate an issue with your use of BLAS and LAPACK.

<!-- https://github.com/wch/r-source/blob/trunk/src/library/tools/R/check.R#L2159 
 tools:::check_compiled_code
 -->
* __Checking compiled code__. Checks that you're not using any C functions
  that you shouldn't. See details in [C best practices](#c-best-practices).

### Tests

<!-- https://github.com/wch/r-source/blob/trunk/src/library/tools/R/check.R#L2514 -->
* __Checking for unstated dependencies in tests__. Every package used by tests 
  must be included in the dependencies.

<!-- https://github.com/wch/r-source/blob/trunk/src/library/tools/R/check.R#L2526 -->
* __Checking tests__.  Each file in `tests/` is run. If you've followed the 
  instructions in [testing](#tests) you'll have at least one file: 
  `testthat.R`. The output from `R CMD check` is not usually that helpful, 
  so you may need to look at the logfile `package.Rcheck/tests/testthat.Rout`.
  Fix any failing tests by iterating with `devtools::test()`. 
  
    Occasionally you may have a problem where the tests pass when run 
    interactively with `devtools::test()`, but fail when in `R CMD check`. This
    usually indicates that you've made a faulty assumption about the testing
    environment, and it's often hard to figure it out. 

### Vignettes

<!-- https://github.com/wch/r-source/blob/trunk/src/library/tools/R/check.R#L718 -->
* __Checking ‘build’ directory__. `build/` is used to track vignette builds. 
  I'm not sure how this check could fail unless you've accidentally 
  `.Rbuildignore`d the `build/` directory.

<!-- https://github.com/wch/r-source/blob/trunk/src/library/tools/R/check.R#L1846 -->
* __Checking installed files from ‘inst/doc’__.  Don't put files in `inst/doc` -
  vignettes now live in `vignettes/`.

<!-- https://github.com/wch/r-source/blob/trunk/src/library/tools/R/check.R#L1941 -->
* __Checking files in ‘vignettes’__. 
  Problems here are usually straightforward - you've included files that are
  already included in R (like `jss.cls`, `jss.bst`, or `Sweave.sty`), or 
  you have leftover latex compilation files. Delete these files.

<!-- https://github.com/wch/r-source/blob/trunk/src/library/tools/R/check.R#L2008 -->
* __Checking for sizes of PDF files under 'inst/doc'__. If you're making PDF
  vignettes, you can make them as small as possible by running 
  `tools::compactPDF()`.

<!-- https://github.com/wch/r-source/blob/trunk/src/library/tools/R/check.R#L2619 -->
* __Checking for unstated dependencies in vignettes__. As with tests, every
  package that you use in a vignette must be listed in the `DESCRIPTION`. 
  If a package is used only for a vignette, and not elsewhere, make sure 
  it's listed in `Suggests`.

<!-- https://github.com/wch/r-source/blob/trunk/src/library/tools/R/check.R#L2629 -->
* __Checking package vignettes in ‘inst/doc’__. This checks that every source
  vignette (i.e. `.Rmd`) has a built equivalent (i.e. `.html`) in `inst/doc`. 
  This shouldn't fail if you've used the standard process outlined in 
  [vignettes](#vignettes). If there is a problem, start by checking your
  `.Rbuildignore`.
  
<!-- https://github.com/wch/r-source/blob/trunk/src/library/tools/R/check.R#L2763 -->
* __Checking running R code from vignettes__. The R code from each vignette 
  is run. If you want to deliberately execute errors (to show the user what 
  failure looks like), make sure the chunk has `error = TRUE, purl = FALSE`.

<!-- https://github.com/wch/r-source/blob/trunk/src/library/tools/R/check.R#L2856 -->
* __Checking re-building of vignette outputs__. Each vignette is re-knit to
  make sure that the output corresponds to the input. Again, this shouldn't
  fail in normal circumstances.
  
To run vignettes, the package first must be installed. That means `check()`:

1. Builds the package.
1. Installs the package without vignettes.
1. Builds all the vignettes.
1. Re-installs the package with vignettes.

If you have a lot of compiled code, this can be rather slow. You may want to add `--no-build-vignettes` to the commands list in "Build Source Packages" field in the project options:

```{r, echo = FALSE}
bookdown::embed_png("screenshots/project-options-build.png", dpi = 220)
```

## Checking after every commit with Travis {#travis}

If you use git and GitHub, as described in [git and GitHub](#git), I highly recommend learning about [Travis](https://travis-ci.org/). Travis is a continuous integration service, which means that it runs automated testing code everytime you push to GitHub. For open source projects, Travis provides 50 minutes of free computation on a ubuntu server for every push. For an R package, the most useful code to run is `devtools::check()`. 

To use Travis:

1.  Run `devtools::use_travis()` to set up a basic `.travis.yml` config file. 

1.  Navigate to your [Travis account](https://travis-ci.org/profile) and enable
    Travis for the repo you want to test.

1.  Commit and push to GitHub.

1.  Wait a few minutes to see the results in your email.

With this setup in place, every time you push to GitHub, and every time someone submits a pull request, `devtools::check()` will be automatically run. You'll find out about failures right away, which makes them easier to fix. Using Travis also encourages me to check more often locally, because I know if it fails I'll find out about it a few minutes later, often once I've moved on to a new problem.

### Basic config

The Travis config is stored in a yaml file called `.travis.yml`. The default config created by devtools looks like this:

```yaml
language: r
warnings_are_errors: true
sudo: required
```

R has recently become a community supported language on Travis and you can read the documentation at  <http://docs.travis-ci.com/user/languages/r/>.

There are two particularly useful options:

`r_github_packages`
 : A list of R packages to install from github. This allows you to test
   against the development version of your depedencies.
 
`r_binary_packages`
 : A list of precompiled R packages to install from ubuntu. This allows 
   you to reduce your the build time. You can see if a binary version of a 
   package is available by searching on <http://packages.ubuntu.com> for 
   `r-cran-lowercasename`. For example, searching for `r-cran-xml` reveals that 
   you can get a binary version of XML package.

### Other uses

Since Travis allows you to run arbitrary code, there are many other things that you can use it for:

* Re-publishing a book website every time you make a change to the source.
  (Like this book!)

* Building vignettes and publishing them to a website.

* Automatically building a documentation website for your package.

To learn more, read about the many [deployment options](http://docs.travis-ci.com/user/deployment/) provided by Travis.
